@page "/add-plan"
@using FitskedApp.DTO
@using FitskedApp.Data
@using FitskedApp.Helpers
@using FitskedApp.Models
@using FitskedApp.Utilities
@using FitskedApp.Data.Repository
@using FitskedApp.Data.Service
@rendermode InteractiveServer
@inject IUserPlanRepository planRepository
@inject IUserExerciseRepository userExerciseRepository
@inject IUserWorkoutRepository userWorkoutRepository
@inject IExerciseService exerciseService
@inject IFilteredExercisesManager exercisesFilterManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ApplicationDbContext ApplicationDbContext
@inject NavigationManager NavManager
@inject IUserService identityUserService
@inject NavigationLinks NavigationLinks

<PageTitle> Add Plan </PageTitle>

    <div class="@((displayDayViewWorkout ? "blurred" : ""))">
        <div class="d-flex justify-content-center">
            <form>
                <div class="col-12 mb-3">
                    <label class="text-black mt-2 pt-2 d-flex justify-content-center poppins-medium" for="PlanName">Plan Name</label>
                <input class="form-control mt-1 w-100 rounded-pill inner-input-shadow border-3 border border-warning" type="text" id="PlanName" @bind="plan.Name" />
                </div>
            </form>
        </div>

        <div class="row border-4 rounded-div border border-warning p-3 bg-white w-auto mb-2  body-box-shadow">
            @foreach (var day in daysOfWeek)
            {
                <div class="col text-center mt-2 mb-2 m-lg-2 day-card rounded-div mr-1 rounded-div border border-3 border-danger ps-2 pe-2" @onclick="() => { if (!displayDayViewWorkout) UserSelectsDay(day);}">
                    <h5 class="mt-2 poppins-medium"> @day </h5>
                <hr />
                    <div class="pt-1">
                        <p class="poppins-bold">  @GetWorkoutTypeByDay(day) </p>  
                    <div  class="rounded-div">
                    <table class="table table-striped table-bordered table-sm table-extra-small-font">
                        <thead>
                            <tr>
                                <th scope="col">Exercise</th>
                                <th scope="col">Sets</th>
                                <th scope="col">Reps</th>
                                <th scope="col">Weight</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach(UserExercise userExercise in ListOfUserExercisePerDay[@day])
                            {
                                <tr>
                                    <td> @userExercise.Name </td>
                                    <td> @userExercise.Sets </td>
                                    <td> @userExercise.Repetitions </td>
                                    <td> @userExercise.Weight </td>
                                </tr>
                            }               
                        </tbody>
                    </table>
                    </div>
                        <p class="poppins-medium exercise-summary-font"> @GetWorkoutSummary(day)</p>
                    </div>
                </div>
            }
        </div>

    <div class="d-flex justify-content-center mt-3">
        <button class="rounded-pill w-25 mb-2 poppins-medium border border-3 border-danger bg-white p-2 main-button" @onclick="NavigationLinks.GoToViewPlansPage"> My Plans </button>
    </div>

    <div class="d-flex justify-content-center mt-3">
        <button class="rounded-pill w-25 mb-2 poppins-medium border border-3 border-danger bg-white p-2 main-button" @onclick="() => { if (!displayDayViewWorkout) AddNewPlan();}"> Save Plan </button>
    </div>

    <div class="d-flex justify-content-center pt-4">
        <p class="poppins-medium">
            <span class="poppins-bold" style="color:green">TIP:</span> If you're time-crunched, save your plan and complete it later in
            <span class="poppins-bold"> My Plans </span>.
            <br />
            Before clicking "Save Plan," be sure to create a filler exercise for each day by clicking each day and selecting "Save Workout."
        </p>
    </div>
    

    @if(displayBlankPlanError)
    {
        <div class="d-flex justify-content-center mt-3">
            <p class="alert-warning"> Give your plan some identity—add a name! </p>
        </div>
    }

    @if (displayUnselectedWorkoutDays)
    {
        
        @foreach(var day in ListStoringUnclickedDays)
        {
            <div class="d-flex justify-content-center mt-3">
                <p class="alert-warning"> Don’t skip @day—add a workout, even if it’s just a filler or rest day! </p>
            </div>
        }
    }
</div>

@if(displayDayViewWorkout)
{
    <div class="overlay">
        <div class="d-flex justify-content-center">
            <div class="bg-white rounded-div border border-4 border-danger shadow-sm mb-3 mt-4 day-view-modal" style="width:90%">
                <div class="d-flex justify-content-center">
                    <h5 class="mt-2 poppins-bold">@selectedDay</h5>
                </div>
                <hr class="border border-2 border-danger" />
                <div class="container d-flex justify-content-center">
                    <EditForm Model="userExercise">
                        <DataAnnotationsValidator />

                        @* <label for="workoutType"> Workout Type: </label> *@
                        <div class="d-flex justify-content-center">
                            @if ((userSelectedWorkoutTypeInDayView == false) && (UserClickCountPerDay[selectedDay] == 0))
                            {
                                <InputSelect class="rounded-pill bg-white inner-input-shadow mt-2 user-exercise-select-height justify-content-center d-flex w-50 text-center blinking-border"
                                             id="workoutType"
                                             @bind-Value="userExercise.WorkoutType"
                                             @bind-Value:after="() => FilterExercisesByWorkoutTypeAsync(selectedDay)">

                                    @foreach (var type in Enum.GetValues(typeof(WorkoutType)).Cast<WorkoutType>().Take(3))
                                    {
                                        if (type == WorkoutType.FillerValue)
                                        {
                                            <option value="@type" disabled selected hidden>@StringValuesForWorkoutType[type]</option>
                                        }
                                        else
                                        {
                                            <option value="@type">@StringValuesForWorkoutType[type]</option>
                                        }
                                    }
                                </InputSelect>
                            }
                            else
                            {
                                <InputSelect class="rounded-pill bg-white inner-input-shadow mt-2 user-exercise-select-height justify-content-center d-flex w-50 text-center"
                                             id="workoutType"
                                             @bind-Value="userExercise.WorkoutType"
                                             @bind-Value:after="() => FilterExercisesByWorkoutTypeAsync(selectedDay)">
                                    
                                    @foreach (var type in Enum.GetValues(typeof(WorkoutType)).Cast<WorkoutType>().Take(3))
                                    {
                                        if (type == WorkoutType.FillerValue)
                                        {
                                            <option value="@type" disabled selected hidden>@StringValuesForWorkoutType[type]</option>
                                        }
                                        else
                                        {
                                            <option value="@type">@StringValuesForWorkoutType[type]</option>
                                        }
                                    }
                                </InputSelect>
                            }
                            
                        </div>
                        <br />
                        @for (int i = 0; i < UserExerciseTotalCountPerDay[selectedDay]; i++)
                        {
                            var j = i;
                            if (j >= listOfUserExercisesInSelectedDay.Count)
                            {
                                listOfUserExercisesInSelectedDay.Add(new UserExercise());
                            }

                            <div class="d-flex justify-content-center mb-2">
                                @if ((userSelectedExerciseTypeInDayView == false) && (UserClickCountPerDay[selectedDay] == 1) && (j == 0))
                                {
                                    @if (userSelectedExerciseInDayViewForVideoIconAppearance == true)
                                    {
                                            <a href="@listOfUserExercisesInSelectedDay[j].VideoUrl" target="_blank" class="text-decoration-none col-1 d-flex justify-content-center align-items-center">
                                                <i class="fa-solid fa-video fa-lg "></i>
                                            </a>
                                        <!-- We will need to create a function that gets the hyperlink for an exercise based on the exercise binding j and the selected day-->
                                    }

                                    <InputSelect class="rounded-pill bg-white inner-input-shadow user-exercise-select-height col-3 text-center blinking-border"
                                                 id="exerciseType"
                                                 @bind-Value="listOfUserExercisesInSelectedDay[j].ExerciseType"
                                                 @bind-Value:after="() => GetListOfIndividualExercisesFromListOfExerciseType(j,selectedDay)">

                                        @foreach (var type in Enum.GetValues(typeof(ExerciseType)).Cast<ExerciseType>().Take(4))
                                        {
                                            if (type == ExerciseType.FillerValue)
                                            {
                                                <option value="@type" disabled selected hidden>@StringValuesForExerciseType[type]</option>
                                            }
                                            else
                                            {
                                                <option value="@type">@StringValuesForExerciseType[type]</option>
                                            }
                                        }
                                    </InputSelect>  
                                }
                                else
                                {
                                    @if (userSelectedExerciseInDayViewForVideoIconAppearance == true)
                                    {
                                        <a href="@listOfUserExercisesInSelectedDay[j].VideoUrl" target="_blank" class="text-decoration-none col-1 d-flex justify-content-center align-items-center">
                                            <i class="fa-solid fa-video fa-lg "></i>
                                        </a>
                                    }
                                    
                                    <InputSelect class="rounded-pill bg-white inner-input-shadow user-exercise-select-height col-3 text-center d-flex align-items-center"
                                                 id="exerciseType"
                                                 @bind-Value="listOfUserExercisesInSelectedDay[j].ExerciseType"
                                                 @bind-Value:after="() => GetListOfIndividualExercisesFromListOfExerciseType(j,selectedDay)">

                                        @foreach (var type in Enum.GetValues(typeof(ExerciseType)).Cast<ExerciseType>().Take(4))
                                        {
                                            if (type == ExerciseType.FillerValue)
                                            {
                                                <option value="@type" disabled selected hidden>@StringValuesForExerciseType[type]</option>
                                            }
                                            else
                                            {
                                                <option value="@type">@StringValuesForExerciseType[type]</option>
                                            }
                                        }
                                    </InputSelect>
                                }


                                @if ((userSelectedExerciseInDayView == false) && (UserClickCountPerDay[selectedDay] == 2) && (j == 0))
                                {
                                    <InputSelect class="rounded-pill bg-white inner-input-shadow user-exercise-select-height col-4 text-center blinking-border d-flex align-items-center" id="exerciseName" @bind-Value="listOfUserExercisesInSelectedDay[j].Name" @bind-Value:after="() => BindValuesFromDtoToUserExercise(listOfUserExercisesInSelectedDay[j],listOfUserExercisesInSelectedDay[j].Name,listOfExercisesByWorkoutType,selectedDay,j)">
                                        <option value="" disabled selected> -- Exercise -- </option>
                                        @foreach (var exercise in listOfUserExercisesInSelectedDay[j].FilteredExercises)
                                        {
                                                <option value="@exercise.Name">@exercise.Name</option>
                                        }
                                    </InputSelect>
                                }
                                else
                                {
                                    <InputSelect class="rounded-pill bg-white inner-input-shadow user-exercise-select-height col-4 text-center d-flex align-items-center" id="exerciseName" @bind-Value="listOfUserExercisesInSelectedDay[j].Name" @bind-Value:after="() => BindValuesFromDtoToUserExercise(listOfUserExercisesInSelectedDay[j],listOfUserExercisesInSelectedDay[j].Name,listOfExercisesByWorkoutType,selectedDay,j)">
                                        <option value="" disabled selected> -- Exercise -- </option>
                                        @foreach (var exercise in listOfUserExercisesInSelectedDay[j].FilteredExercises)
                                        {
                                                <option value="@exercise.Name">@exercise.Name</option>

                                        }
                                    </InputSelect>
                                }


                                <InputSelect class="rounded-pill bg-white inner-input-shadow user-exercise-select-height col-1 text-center d-flex align-items-center" id="sets" @bind-Value="listOfUserExercisesInSelectedDay[j].Sets">
                                        <option value="" disabled selected> -- Sets -- </option>
                                        @foreach (var setNumber in ListOfSets)
                                        {
                                            <option value="@setNumber">@setNumber</option>
                                        }
                                    </InputSelect>

                                <InputSelect class="rounded-pill bg-white inner-input-shadow user-exercise-select-height col-1 text-center d-flex align-items-center" id="reps" @bind-Value="listOfUserExercisesInSelectedDay[j].Repetitions">
                                        <option value="" disabled selected> -- Reps -- </option>
                                        @foreach (var repNumber in ListOfReps)
                                        {
                                            <option value="@repNumber">@repNumber</option>
                                        }
                                    </InputSelect>

                                <InputSelect class="rounded-pill bg-white inner-input-shadow user-exercise-select-height col-2 text-center d-flex align-items-center" id="weight" @bind-Value="listOfUserExercisesInSelectedDay[j].Weight">
                                        <option value="" disabled selected> -- Weight -- </option>
                                        @foreach (var weightNumber in ListOfWeight)
                                        {
                                            <option value="@weightNumber">@weightNumber lbs.</option>
                                        }
                                    </InputSelect>

                                @if ((j > 0) && (j == UserExerciseTotalCountPerDay[selectedDay] - 1))
                                {
                                    <button class=" end-0 me-5 mt-2 rounded-pill border border-2 border-danger poppins-medium bg-white user-exercise-select-height col-2" @onclick="() => ThingsToDoOnClickRemove(selectedDay,j,listOfUserExercisesInSelectedDay[j].Name, listOfUserExercisesInSelectedDay[j].FilteredExercises,listOfUserExercisesInSelectedDay[j])">
                                        Remove
                                    </button>
                                }
                            </div>
                        }
                        <div>
                            <button class="mt-3 rounded-pill mb-4 border border-2 border-danger poppins-medium bg-white main-button p-2" @onclick="() =>  AddAdditionalExerciseToWorkout(selectedDay)">
                                Add Exercise
                            </button>
                        </div>

                        <div class="d-flex justify-content-center">
                            <button class="mt-3 rounded-pill mb-4 border border-2 border-danger poppins-medium bg-white main-button p-2" @onclick="SaveUserWorkoutToInMemoryListOfUserWorkouts">Add Workout</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private Plan plan = new();
    private UserExercise userExercise = new();
    public WorkoutType workoutType = new();

    private bool displayDayViewWorkout = false;
    private bool displayUnselectedWorkoutDays = false;
    private bool displayBlankPlanError = false;
    private bool userHasEnteredPlanName = false;
    private bool userSelectedWorkoutTypeInDayView = false;
    private bool userSelectedExerciseTypeInDayView = true;
    private bool userSelectedExerciseInDayView = true;
    private bool userSelectedExerciseInDayViewForVideoIconAppearance = false;
    private int numberOfExercisesInWorkout = 1;
    private string selectedDay = string.Empty;

    private string[] daysOfWeek = new string[] { "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" };

    private List<int> ListOfSets = ListOfNumberHelper.GenerateListOfNumbers(1, 10, 1);
    private List<int> ListOfReps = ListOfNumberHelper.GenerateListOfNumbers(2, 20, 2);
    private List<int> ListOfWeight = ListOfNumberHelper.GenerateListOfNumbers(0, 405, 5);
    private List<string> ListStoringUnclickedDays = new List<string> { "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" };
    private List<UserExercise> listOfUserExercisesInSelectedDay = new();
    private List<UserWorkout> workoutListForCurrentPlan = new();
    private List<ExerciseDTO> fullListOfExerciseDTO = new();
    private List<ExerciseDTO> listStoringSelectedExercises = new();
    public List<ExerciseDTO> listOfExercisesByWorkoutType = new();

    public Dictionary<string, List<UserExercise>> ListOfUserExercisePerDay = new();
    public Dictionary<string, Dictionary<int, string>> previousExerciseSelectionsPerDay = new()
{
    { "Sunday", new Dictionary<int, string>() },
    { "Monday", new Dictionary<int, string>() },
    { "Tuesday", new Dictionary<int, string>() },
    { "Wednesday", new Dictionary<int, string>() },
    { "Thursday", new Dictionary<int, string>() },
    { "Friday", new Dictionary<int, string>() },
    { "Saturday", new Dictionary<int, string>() }
};
    public Dictionary<WorkoutType, Dictionary<ExerciseType, List<ExerciseDTO>>> DictionaryStoringFilteredExercises = new()
    {
        { WorkoutType.UpperBodyStrength, new Dictionary<ExerciseType, List<ExerciseDTO>>
            {
                { ExerciseType.Core, new List<ExerciseDTO>() },
                { ExerciseType.Secondary, new List<ExerciseDTO>() },
                { ExerciseType.Accessory, new List<ExerciseDTO>() }
            }
        },
        { WorkoutType.LowerBodyStrength, new Dictionary<ExerciseType, List<ExerciseDTO>>
            {
                { ExerciseType.Core, new List<ExerciseDTO>() },
                { ExerciseType.Secondary, new List<ExerciseDTO>() },
                { ExerciseType.Accessory, new List<ExerciseDTO>() }
            }
        }
    };    
    private static readonly Dictionary<WorkoutType, string> StringValuesForWorkoutType = new()
    {
            {WorkoutType.FillerValue, " -- Workout Type -- "},
            {WorkoutType.UpperBodyStrength, "Upper Body" },
            {WorkoutType.LowerBodyStrength, "Lower Body" }
    };
    private static readonly Dictionary<ExerciseType, string> StringValuesForExerciseType = new()
    {
        {ExerciseType.FillerValue, " -- Exercise Type -- "},
        {ExerciseType.Core, "Core"},
        {ExerciseType.Secondary, "Secondary"},
        {ExerciseType.Accessory, "Accessory"}
    };
    private Dictionary<string, int> ListPositionForDay = new Dictionary<string, int>
    {
        { "Sunday", 0 },
        { "Monday", 1 },
        { "Tuesday", 2 },
        { "Wednesday", 3 },
        { "Thursday", 4 },
        { "Friday", 5 },
        { "Saturday", 6 }
    };
    public Dictionary<string, int> UserExerciseTotalCountPerDay = new Dictionary<string, int>
    {
        { "Sunday", 1},
        { "Monday", 1 },
        { "Tuesday", 1},
        { "Wednesday", 1},
        { "Thursday", 1 },
        { "Friday", 1},
        { "Saturday", 1}
    };
    public Dictionary<string, int> UserClickCountPerDay = new Dictionary<string, int>
    {
        { "Sunday", 0},
        { "Monday", 0},
        { "Tuesday", 0},
        { "Wednesday", 0},
        { "Thursday", 0},
        { "Friday", 0},
        { "Saturday", 0}
    };


    protected override async Task OnInitializedAsync()
    {
        foreach (var day in daysOfWeek)
        {
            if (!ListOfUserExercisePerDay.ContainsKey(day))
            {
                ListOfUserExercisePerDay[day] = new List<UserExercise>();
            }
        }

        for(int i = 0; i < 7; i++)
        {
            var j = i;
            UserWorkout newWorkout = new UserWorkout();
            exercisesFilterManager.AddItemToList(newWorkout, workoutListForCurrentPlan);
        }
        fullListOfExerciseDTO = await exerciseService.GetFullExerciseListAsync();
    }

    private void UserSelectsDay(string day)
    {
        selectedDay = day;
        if (ListOfUserExercisePerDay[day].FirstOrDefault() == null)
        {
            userExercise.WorkoutType = WorkoutType.FillerValue;
        }
        else
        {
            userExercise.WorkoutType = ListOfUserExercisePerDay[day].FirstOrDefault().WorkoutType;
        }
        listOfUserExercisesInSelectedDay = ListOfUserExercisePerDay[day];
        UpdateSelectableExerciseListForEachUserExercise(DictionaryStoringFilteredExercises, listOfUserExercisesInSelectedDay);
        displayDayViewWorkout = true;
        ListStoringUnclickedDays.RemoveAll(e => e.Equals(selectedDay));
        StateHasChanged();
    }

    private void SaveUserWorkoutToInMemoryListOfUserWorkouts()
    {
        if (ListPositionForDay.ContainsKey(selectedDay))
        {
            ListOfUserExercisePerDay[selectedDay] = listOfUserExercisesInSelectedDay;

            int dayIndex = ListPositionForDay[selectedDay];


            workoutListForCurrentPlan.RemoveAt(dayIndex);

            UserWorkout userWorkout = new UserWorkout
                {
                    PlanId = plan.Id,
                    UserExercises = listOfUserExercisesInSelectedDay
                };

            workoutListForCurrentPlan.Insert(dayIndex, userWorkout);
            displayDayViewWorkout = false;
            userSelectedWorkoutTypeInDayView = false;
            userSelectedExerciseTypeInDayView = true;
            userSelectedExerciseInDayView = true;
            // will most likely need to do something with this userSelectedExerciseInDayViewForVideoIconAppearance
            // Will probably need to keep track of it per day.
            // PutSelectedExercisesInFilteredBin(ListOfUserExercisePerDay, selectedDay); // I don't think we need this anymore is we are adding the exercise in a different location, onclick exactly. This just adds an additional exercise and its not necessary!
            StateHasChanged();
        }
    }

    public void FilterExercisesByWorkoutTypeAsync(string day)
    {
        userSelectedWorkoutTypeInDayView = true;
        userSelectedExerciseTypeInDayView = false;

        if (UserClickCountPerDay[day] < 3)
        {
            UserClickCountPerDay[day]++;
        }


        listOfExercisesByWorkoutType = exerciseService.GetExerciseListBasedOnWorkoutType(userExercise.WorkoutType, fullListOfExerciseDTO);
        foreach (var exercise in listOfUserExercisesInSelectedDay)
        {
            exercise.FilteredExercises = userExerciseRepository.GetExercisesFromWorkoutListBasedOnExerciseType(listOfExercisesByWorkoutType, exercise.ExerciseType);
        }

        StateHasChanged();
    }

    public void PutSelectedExercisesInFilteredBin(Dictionary<string, List<UserExercise>> listOfUserExercisePerDay, string selectedDay)
    {
        foreach (UserExercise exercise in listOfUserExercisePerDay[selectedDay])
        {
            if (!string.IsNullOrEmpty(exercise.Name))
            {
                ExerciseDTO dto = new ExerciseDTO
                    {
                        Name = exercise.Name,
                        VideoUrl = exercise.VideoUrl,
                        ExerciseType = exercise.ExerciseType,
                        WorkoutType = exercise.WorkoutType
                    };

                DictionaryStoringFilteredExercises[dto.WorkoutType][dto.ExerciseType].Add(dto);
            }
        }
    }

    public void UpdateSelectableExerciseListForEachUserExercise(
    Dictionary<WorkoutType, Dictionary<ExerciseType, List<ExerciseDTO>>> dictionaryWithSelectedExercises,
    List<UserExercise> listOfUserExercisesForDay)
    {
        if (listOfUserExercisesForDay.Count == 0) return;

        foreach (UserExercise userExercise in listOfUserExercisesForDay)
        {
            UpdateFilteredExercisesForUserExercise(dictionaryWithSelectedExercises, userExercise);
        }

        StateHasChanged();
    }
    
    public void UpdateSelectableExerciseListForEachUserExercise(
        Dictionary<WorkoutType, Dictionary<ExerciseType, List<ExerciseDTO>>> dictionaryWithSelectedExercises,
        List<UserExercise> listOfUserExercisesForDay,
        UserExercise clickedUserExercise)
    {
        if (listOfUserExercisesForDay.Count == 0) return;

        foreach (UserExercise userExercise in listOfUserExercisesForDay)
        {
            if (userExercise != clickedUserExercise)
            {
                UpdateFilteredExercisesForUserExercise(dictionaryWithSelectedExercises, userExercise);
            }
        }

        StateHasChanged();
    }



    // private void UpdateFilteredExercisesForUserExercise(
    //     Dictionary<WorkoutType, Dictionary<ExerciseType, List<ExerciseDTO>>> dictionaryWithSelectedExercises,
    //     UserExercise userExercise)
    // {
    //     WorkoutType workoutType = userExercise.WorkoutType;
    //     ExerciseType exerciseType = userExercise.ExerciseType;
    //     string selectedExerciseName = userExercise.Name;

    //     // So before the following LINQ query, we might have to remove Deadlift from the filteredlist BEFORE the linq query
    //     var exercisesToRemove = userExercise.FilteredExercises
    //         .Where(exercise => exercise.Name != selectedExerciseName && 
    //             dictionaryWithSelectedExercises[workoutType][exerciseType].Any(selectedExercise => selectedExercise.Name == exercise.Name)).ToList();

    //     var exercisesToAdd = ExercisesToAddToFilteredUserExerciseLists(userExercise);

    //     exercisesFilterManager.RemoveItemsFromList(exercisesToRemove, userExercise.FilteredExercises);
    //     var exercise = userExercise.FilteredExercises.Where(e => e.Name == userExercise.Name);

    //     exercisesFilterManager.AddItemsToList(exercisesToAdd, userExercise.FilteredExercises);
    // }

    private void UpdateFilteredExercisesForUserExercise(
    Dictionary<WorkoutType, Dictionary<ExerciseType, List<ExerciseDTO>>> dictionaryWithSelectedExercises,
    UserExercise userExercise)
    {
        WorkoutType workoutType = userExercise.WorkoutType;
        ExerciseType exerciseType = userExercise.ExerciseType;
        string selectedExerciseName = userExercise.Name;

        // Remove exercises that match criteria for removal
        var exercisesToRemove = userExercise.FilteredExercises
            .Where(exercise => exercise.Name != selectedExerciseName &&
                dictionaryWithSelectedExercises[workoutType][exerciseType].Any(selectedExercise => selectedExercise.Name == exercise.Name)).ToList();

        // Determine exercises to add to filtered list
        var exercisesToAdd = ExercisesToAddToFilteredUserExerciseLists(userExercise);

        // Perform removal and addition operations
        exercisesFilterManager.RemoveItemsFromList(exercisesToRemove, userExercise.FilteredExercises);
        exercisesFilterManager.AddItemsToList(exercisesToAdd, userExercise.FilteredExercises);

        // Move the current selected exercise to the top of the filtered list
        var selectedExercise = userExercise.FilteredExercises.FirstOrDefault(e => e.Name == selectedExerciseName);
        if (selectedExercise != null)
        {
            userExercise.FilteredExercises.Remove(selectedExercise);
            userExercise.FilteredExercises.Insert(0, selectedExercise);
        }
    }

    

    

    private List<ExerciseDTO> ExercisesToAddToFilteredUserExerciseLists(UserExercise userExercise)
    {
        return fullListOfExerciseDTO
            .Where(dto => dto.WorkoutType == userExercise.WorkoutType &&
                          dto.ExerciseType == userExercise.ExerciseType &&
                          !userExercise.FilteredExercises.Any(filtered => filtered.Name == dto.Name))
            .ToList();
    }

    public void UpdateListOfPreviouslySelectedExercisesForSelectedDay(int j, string selectedDay, string name, WorkoutType workoutType, ExerciseType exerciseType)
    {
        if (previousExerciseSelectionsPerDay[selectedDay][j] != name)
        {
            ExerciseDTO previouslySelectedexerciseDTO = listStoringSelectedExercises.Find(e => e.Name == previousExerciseSelectionsPerDay[selectedDay][j]);
            fullListOfExerciseDTO.Add(previouslySelectedexerciseDTO);
            listStoringSelectedExercises.Remove(previouslySelectedexerciseDTO);
            DictionaryStoringFilteredExercises[workoutType][exerciseType].RemoveAll(e => e.Name == previouslySelectedexerciseDTO.Name);
            previousExerciseSelectionsPerDay[selectedDay][j] = name;
        }
    }

    public void RemoveSelectedExerciseFromAvailableList(string exerciseName, string day, int j)
    {
        ExerciseDTO dto = fullListOfExerciseDTO.Find(e => e.Name == exerciseName);
        exercisesFilterManager.AddItemToList(dto, listStoringSelectedExercises);

        fullListOfExerciseDTO.RemoveAll(e => e.Name == exerciseName);

        if (!previousExerciseSelectionsPerDay[day].ContainsKey(j))
        {
            previousExerciseSelectionsPerDay[day].Add(j, exerciseName);
        }
        StateHasChanged();
    }

    private void RemoveExerciseFromExerciseListFilteredByWorkoutType(string name, List<ExerciseDTO> filteredExerciseList, int j, string day)
    {
        filteredExerciseList.RemoveAll(e => e.Name == name);

        if (previousExerciseSelectionsPerDay[selectedDay][j] != name)
        {
            ExerciseDTO exerciseDTO = listStoringSelectedExercises.Find(e => e.Name == previousExerciseSelectionsPerDay[selectedDay][j]);
            exercisesFilterManager.AddItemToList(exerciseDTO, filteredExerciseList);
        }
        StateHasChanged();
    }



    private void ThingsToDoOnClickRemove(string day, int i, string exerciseName, List<ExerciseDTO> listOfExDto, UserExercise exercise)
    {
        if (!string.IsNullOrEmpty(exerciseName))
        {
            ExerciseDTO exerciseDTO = GetExerciseDTOFromListStoringSelectedExercises(exerciseName);

            exercisesFilterManager.AddItemToList(exerciseDTO, fullListOfExerciseDTO);
            // exercisesFilterManager.AddItemToList(exerciseDTO, intermediaryExerciseList);

            if (previousExerciseSelectionsPerDay.ContainsKey(day)
                && previousExerciseSelectionsPerDay[day].ContainsKey(i))
            {
                previousExerciseSelectionsPerDay[day].Remove(i);
            }

            exercisesFilterManager.RemoveItemFromList(exerciseDTO, listStoringSelectedExercises);
            listOfExercisesByWorkoutType.Add(exerciseDTO); // I believe we are already doing this somethingwhere. This should do the trick for now but we really not the find where the exercise is getting readded and use that.
            DictionaryStoringFilteredExercises[exercise.WorkoutType][exercise.ExerciseType].RemoveAll(e => e.Name == exerciseName); // Might need to add some exception handling around here. 
            UpdateSelectableExerciseListForEachUserExercise(DictionaryStoringFilteredExercises, ListOfUserExercisePerDay[day],exercise);
        }

        RemoveAdditionalExerciseFromWorkout(day);
        StateHasChanged();
    }

    public ExerciseDTO GetExerciseDTOFromListStoringSelectedExercises(string name)
    {
        ExerciseDTO previouslySelectedxerciseDTO = listStoringSelectedExercises.Find(e => e.Name == name);
        return previouslySelectedxerciseDTO;
    }

    public async Task GetListOfIndividualExercisesFromListOfExerciseType(int index, string day)
    {
        userSelectedExerciseTypeInDayView = true;
        userSelectedExerciseInDayView = false;
        if (UserClickCountPerDay[day] < 3)
        {
            UserClickCountPerDay[day]++;
        }

        var selectedExerciseType = listOfUserExercisesInSelectedDay[index].ExerciseType;
        listOfUserExercisesInSelectedDay[index].FilteredExercises = userExerciseRepository.GetExercisesFromWorkoutListBasedOnExerciseType(listOfExercisesByWorkoutType, selectedExerciseType);
        // ListOfUserExercisesInSelectedDay probably needs to be updated as well.
        await InvokeAsync(StateHasChanged);
    }

    public string GetWorkoutTypeByDay(string day)
    {
        if (ListOfUserExercisePerDay.TryGetValue(day, out var userWorkout) && userWorkout?.Any() == true)
        {
            var userExercise = userWorkout.FirstOrDefault();
            if (userExercise != null)
            {
                var enumValue = userExercise.WorkoutType;
                switch (enumValue)
                {
                    case WorkoutType.UpperBodyStrength:
                        return "Upper Body";

                    case WorkoutType.LowerBodyStrength:
                        return "Lower Body";

                    default:
                        return "Nothing going on today";
                }
            }
        }
        return "Workout Type Unselected";
    }

    private string GetWorkoutSummary(string day)
    {
        if (ListOfUserExercisePerDay.TryGetValue(day, out var exercises) && exercises.Any())
        {
            return "";
        }
        return "No Exercises Added.";
    }

    private async Task AddNewPlan()
    {
        CheckIfPlanNameHasValue(plan);
        if(userHasEnteredPlanName)
        {
            if(ListStoringUnclickedDays.Count == 0)
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity?.IsAuthenticated == true)
                {
                    var userId = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                    if (!string.IsNullOrEmpty(userId))
                    {
                        plan.ApplicationUserId = userId;
                    }

                    var transaction = await ApplicationDbContext.Database.BeginTransactionAsync();
                    try
                    {
                        int planId = await planRepository.AddPlan(plan);

                        await userWorkoutRepository.PersistListOfUserWorkoutsToDatabaseAsync(workoutListForCurrentPlan, planId);

                        await transaction.CommitAsync();
                        plan = new Plan();
                        NavigationLinks.GoToViewPlansPage();
                    }
                    catch (Exception e)
                    {
                        await transaction.RollbackAsync();
                        throw new Exception($"Something went wrong with the database transaction: {e.Message}");
                    }
                }
            }
            else
            {
                displayUnselectedWorkoutDays = true;
            }
        }
        else
        {
            displayBlankPlanError = true;
            CheckIfUserHasCreatedWorkoutForEveryDay(ListStoringUnclickedDays);
        }
    }

    public void CheckIfPlanNameHasValue(Plan plan)
    {
        if(plan.Name != null)
        {
            userHasEnteredPlanName = true;
        }
    }

    public void CheckIfUserHasCreatedWorkoutForEveryDay(List<string> selectedDays)
    {
        if(selectedDays.Count != 0)
        {
            displayUnselectedWorkoutDays = true;
        }
    }

    




    private void AddAdditionalExerciseToWorkout(string day)
    {
        if (UserExerciseTotalCountPerDay[day] < 8)
        {
            UserExerciseTotalCountPerDay[day] += 1;
            StateHasChanged();
        }
    }
    
    private void RemoveAdditionalExerciseFromWorkout(string day)
    {
        UserExerciseTotalCountPerDay[day] -= 1;
        listOfUserExercisesInSelectedDay.RemoveAt(listOfUserExercisesInSelectedDay.Count - 1);
        StateHasChanged();
    }

    public void PutExerciseIdInUserExerciseBasedOnName(UserExercise userExercise, string name, List<ExerciseDTO> listOfExercisesToFilterOn)
    {
        var filteredExercise = listOfExercisesToFilterOn.Where(e => e.Name == name).FirstOrDefault();
        userExercise.ExerciseId = filteredExercise.ExerciseId;
    }

    public void PutWorkoutTypeInUserExerciseBasedOnName(UserExercise userExercise,string name, List<ExerciseDTO> listOfExercisesToFilterOn)
    {
        var filteredExercise = listOfExercisesToFilterOn.Where(e => e.Name == name).FirstOrDefault();
        userExercise.WorkoutType = filteredExercise.WorkoutType;
    }

    public void PutExerciseTypeInUserExerciseBasedOnName(UserExercise userExercise, string name, List<ExerciseDTO> listOfExercisesToFilterOn)
    {
        var filteredExercise = listOfExercisesToFilterOn.Where(e => e.Name == name).FirstOrDefault(); // Really this should be put into its own method
        userExercise.ExerciseType = filteredExercise.ExerciseType;
    }

    public void PutVideoUrlInUserExerciseBasedOnName(UserExercise userExercise, string name, List<ExerciseDTO> listOfExercisesToFilterOn)
    {
        var filteredExercise = listOfExercisesToFilterOn.Where(e => e.Name == name).FirstOrDefault(); // Really this should be put into its own method
        userExercise.VideoUrl = filteredExercise.VideoUrl;
    }

    public void BindValuesFromDtoToUserExercise(UserExercise userExercise, string name, List<ExerciseDTO> listOfExercisesToFilterOn,string day, int j)
    {
        userSelectedExerciseInDayView = true;
        userSelectedExerciseInDayViewForVideoIconAppearance = true;

        if (UserClickCountPerDay[day] < 3)
        {
            UserClickCountPerDay[day]++;
        }

        PutExerciseIdInUserExerciseBasedOnName(userExercise, name, listOfExercisesToFilterOn);
        PutExerciseTypeInUserExerciseBasedOnName(userExercise, name, listOfExercisesToFilterOn);
        PutWorkoutTypeInUserExerciseBasedOnName(userExercise, name, listOfExercisesToFilterOn);
        PutVideoUrlInUserExerciseBasedOnName(userExercise, name, listOfExercisesToFilterOn);

        RemoveSelectedExerciseFromAvailableList(name,day,j);
        RemoveExerciseFromExerciseListFilteredByWorkoutType(name, listOfExercisesToFilterOn, j, day);
        UpdateListOfPreviouslySelectedExercisesForSelectedDay(j, day, name, userExercise.WorkoutType, userExercise.ExerciseType);
        
        // Right now, the FilteredExercises for each UserExercise in each day in being updated upon user selecting the day. Now, we need the same functionality to happen
        // Consider putting the below after onclick to create that dynamic user experience:
        PutSelectedExercisesInFilteredBin(ListOfUserExercisePerDay, day);
        UpdateSelectableExerciseListForEachUserExercise(DictionaryStoringFilteredExercises, listOfUserExercisesInSelectedDay, userExercise);

        StateHasChanged();
    } 
}
